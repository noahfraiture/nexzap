// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.28.0
// source: main.sql

package db

import (
	"context"
	"time"

	"github.com/google/uuid"
)

const findLastTutorialFirstSheet = `-- name: FindLastTutorialFirstSheet :one
SELECT
  tu.title,
  tu.highlight,
  tu.code_editor,
  s.id,
  s.guide_content,
  s.exercise_content,
  s.page,
  s.submission_content,
  (SELECT COUNT(page) FROM sheets sh WHERE sh.tutorial_id = tu.id) as total_pages
FROM
  tutorials tu
  JOIN sheets s ON s.tutorial_id = tu.id
WHERE
  s.page = 1
  AND tu.unlock < NOW ()
ORDER BY
  tu.updated_at DESC,
  tu.version DESC
LIMIT
  1
`

type FindLastTutorialFirstSheetRow struct {
	Title             string
	Highlight         string
	CodeEditor        string
	ID                uuid.UUID
	GuideContent      string
	ExerciseContent   string
	Page              int32
	SubmissionContent string
	TotalPages        int64
}

func (q *Queries) FindLastTutorialFirstSheet(ctx context.Context) (FindLastTutorialFirstSheetRow, error) {
	row := q.db.QueryRow(ctx, findLastTutorialFirstSheet)
	var i FindLastTutorialFirstSheetRow
	err := row.Scan(
		&i.Title,
		&i.Highlight,
		&i.CodeEditor,
		&i.ID,
		&i.GuideContent,
		&i.ExerciseContent,
		&i.Page,
		&i.SubmissionContent,
		&i.TotalPages,
	)
	return i, err
}

const findLastTutorialSheet = `-- name: FindLastTutorialSheet :one
SELECT
  tu.title,
  tu.highlight,
  tu.code_editor,
  s.id,
  s.guide_content,
  s.exercise_content,
  s.page,
  s.submission_content,
  (SELECT COUNT(page) FROM sheets sh WHERE sh.tutorial_id = tu.id) as total_pages
FROM
  tutorials tu
  JOIN sheets s ON s.tutorial_id = tu.id
WHERE
  s.page = $1
  AND tu.unlock < NOW ()
ORDER BY
  tu.updated_at DESC,
  tu.version DESC
LIMIT
  1
`

type FindLastTutorialSheetRow struct {
	Title             string
	Highlight         string
	CodeEditor        string
	ID                uuid.UUID
	GuideContent      string
	ExerciseContent   string
	Page              int32
	SubmissionContent string
	TotalPages        int64
}

func (q *Queries) FindLastTutorialSheet(ctx context.Context, page int32) (FindLastTutorialSheetRow, error) {
	row := q.db.QueryRow(ctx, findLastTutorialSheet, page)
	var i FindLastTutorialSheetRow
	err := row.Scan(
		&i.Title,
		&i.Highlight,
		&i.CodeEditor,
		&i.ID,
		&i.GuideContent,
		&i.ExerciseContent,
		&i.Page,
		&i.SubmissionContent,
		&i.TotalPages,
	)
	return i, err
}

const findSubmissionData = `-- name: FindSubmissionData :one
SELECT
  s.docker_image,
  s.command,
  s.submission_name,
  array_agg(f.name)::text[] AS files_name,
  array_agg(f.content)::text[] AS files_content
FROM
  sheets s
  JOIN files f ON f.sheet_id = s.id
WHERE
  s.id = $1
GROUP BY
  s.id, s.docker_image, s.command, s.submission_name
`

type FindSubmissionDataRow struct {
	DockerImage    string
	Command        string
	SubmissionName string
	FilesName      []string
	FilesContent   []string
}

func (q *Queries) FindSubmissionData(ctx context.Context, sheetID uuid.UUID) (FindSubmissionDataRow, error) {
	row := q.db.QueryRow(ctx, findSubmissionData, sheetID)
	var i FindSubmissionDataRow
	err := row.Scan(
		&i.DockerImage,
		&i.Command,
		&i.SubmissionName,
		&i.FilesName,
		&i.FilesContent,
	)
	return i, err
}

const insertFiles = `-- name: InsertFiles :exec
INSERT INTO files (name, content, sheet_id)
SELECT unnest($1::text[]), unnest($2::text[]), $3
`

type InsertFilesParams struct {
	Names    []string
	Contents []string
	SheetID  uuid.UUID
}

func (q *Queries) InsertFiles(ctx context.Context, arg InsertFilesParams) error {
	_, err := q.db.Exec(ctx, insertFiles, arg.Names, arg.Contents, arg.SheetID)
	return err
}

const insertTutorial = `-- name: InsertTutorial :many
WITH tutorial AS (
  INSERT INTO tutorials (title, highlight, code_editor, version, unlock)
  VALUES ($1, $2, $3, $4, $5)
  RETURNING id
), sheet AS (
  INSERT INTO sheets (
    tutorial_id,
    page,
    guide_content,
    exercise_content,
    submission_name,
    submission_content,
    docker_image,
    command
  )
  SELECT
    (SELECT id FROM tutorial),
    unnest($6::integer[]),
    unnest($7::text[]),
    unnest($8::text[]),
    unnest($9::text[]),
    unnest($10::text[]),
    unnest($11::text[]),
    unnest($12::text[])
  RETURNING id
)
SELECT id FROM sheet
`

type InsertTutorialParams struct {
	Title              string
	Highlight          string
	CodeEditor         string
	Version            int32
	Unlock             time.Time
	Pages              []int32
	GuidesContent      []string
	ExercisesContent   []string
	SubmissionsName    []string
	SubmissionsContent []string
	DockerImages       []string
	Commands           []string
}

func (q *Queries) InsertTutorial(ctx context.Context, arg InsertTutorialParams) ([]uuid.UUID, error) {
	rows, err := q.db.Query(ctx, insertTutorial,
		arg.Title,
		arg.Highlight,
		arg.CodeEditor,
		arg.Version,
		arg.Unlock,
		arg.Pages,
		arg.GuidesContent,
		arg.ExercisesContent,
		arg.SubmissionsName,
		arg.SubmissionsContent,
		arg.DockerImages,
		arg.Commands,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []uuid.UUID
	for rows.Next() {
		var id uuid.UUID
		if err := rows.Scan(&id); err != nil {
			return nil, err
		}
		items = append(items, id)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
